name: Deploy Photographer Node Backend to Testing Server

on:
  push:
    branches:
      - main   # Deploy only when pushing to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install zip
      - name: Install zip
        run: sudo apt-get install zip -y

      # 3Ô∏è‚É£ Create deployment zip
      - name: Create ZIP
        run: |
          zip -r api_photographer_api.zip . -x "*.git*"

      # 4Ô∏è‚É£ Install sshpass
      - name: Install sshpass
        run: sudo apt-get install sshpass -y

      # 5Ô∏è‚É£ Upload ZIP to Server
      - name: Upload to Server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          sshpass -p "$SERVER_PASSWORD" scp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            api_photographer_api.zip \
            $SERVER_USER@$SERVER_HOST:$SERVER_PATH/

      # 6Ô∏è‚É£ Remote Deploy Commands
      - name: Remote Deploy & PM2 Restart
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          PM2_APP_NAME: ${{ secrets.PM2_APP_NAME }}
          NODE_PATH: ${{ secrets.NODE_PATH }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SERVER_USER@$SERVER_HOST << EOF

          set -e
          cd $SERVER_PATH

          echo "üìÇ Extracting files..."
          unzip -o api_photographer_api.zip
          rm -f api_photographer_api.zip

          export PATH=$NODE_PATH:\$PATH

          echo "üß™ Versions:"
          node -v
          npm -v
          pm2 -v

          echo "üì¶ Installing dependencies..."
          npm install

          echo "üîÅ Restarting PM2..."
          pm2 restart $PM2_APP_NAME || pm2 start app.js --name $PM2_APP_NAME

          pm2 save

          rm -rf .git

          echo "‚úÖ Deployment completed"
          EOF
